# =========================================================
# PIPELINE CD – Weather App
# Deploy em ambientes: TESTE → QA → PRODUÇÃO
# =========================================================

# Este pipeline NÃO dispara por push
# Ele é acionado automaticamente quando o pipeline de CI finaliza
trigger: none

# =========================================================
# RECURSO: PIPELINE DE CI
# =========================================================
resources:
  pipelines:
    - pipeline: ci
      source: JulioCesarSantosdv.weather-app-azure
      trigger: true   # Dispara este CD quando o CI gerar artifact

# =========================================================
# STAGES
# =========================================================
stages:

# =========================================================
# STAGE: TESTE
# =========================================================
- stage: Teste
  displayName: "Deploy TESTE"

  jobs:
    - job: DeployTeste
      displayName: "Deploy no Storage TESTE"
      pool:
        vmImage: ubuntu-latest

      steps:
        # 1) Baixa o artifact ZIP gerado pelo CI
        - download: ci
          artifact: drop

        # 2) Extrai o ZIP
        # IMPORTANTE:
        # Azure Static Website NÃO interpreta ZIP
        - task: ExtractFiles@1
          displayName: "Extrair artifact TESTE"
          inputs:
            archiveFilePatterns: '$(Pipeline.Workspace)/ci/drop/*.zip'
            destinationFolder: '$(Pipeline.Workspace)/extracted'
            cleanDestinationFolder: true

        # 3) Faz upload SOMENTE dos arquivos extraídos
        - task: AzureCLI@2
          displayName: "Deploy no Azure Blob TESTE"
          inputs:
            azureSubscription: "sc-weather-app-cicd"
            scriptType: bash
            scriptLocation: inlineScript
            inlineScript: |
              az storage blob upload-batch \
                --account-name weatherappteste \
                --destination \$web \
                --source $(Pipeline.Workspace)/extracted \
                --auth-mode login

# =========================================================
# STAGE: QA
# =========================================================
- stage: QA
  displayName: "Deploy QA"
  dependsOn: Teste   # Só executa se TESTE passar

  jobs:
    - job: DeployQA
      displayName: "Deploy no Storage QA"
      pool:
        vmImage: ubuntu-latest

      steps:
        # 1) Baixa o MESMO artifact do CI
        - download: ci
          artifact: drop

        # 2) Extrai o ZIP novamente
        - task: ExtractFiles@1
          displayName: "Extrair artifact QA"
          inputs:
            archiveFilePatterns: '$(Pipeline.Workspace)/ci/drop/*.zip'
            destinationFolder: '$(Pipeline.Workspace)/extracted'
            cleanDestinationFolder: true

        # 3) Upload para a Storage Account de QA
        - task: AzureCLI@2
          displayName: "Deploy no Azure Blob QA"
          inputs:
            azureSubscription: "sc-weather-app-cicd"
            scriptType: bash
            scriptLocation: inlineScript
            inlineScript: |
              az storage blob upload-batch \
                --account-name weatherappqa \
                --destination \$web \
                --source $(Pipeline.Workspace)/extracted \
                --auth-mode login

# =========================================================
# STAGE: PRODUÇÃO
# =========================================================
- stage: Producao
  displayName: "Deploy PRODUÇÃO"
  dependsOn: QA   # Só executa se QA passar

  jobs:
    # Deployment Job → permite Environment + aprovação manual
    - deployment: DeployProducao
      displayName: "Deploy no Storage PRODUÇÃO"
      environment: Producao   # Ambiente configurado no Azure DevOps
      pool:
        vmImage: ubuntu-latest

      strategy:
        runOnce:
          deploy:
            steps:
              # 1) Baixa o artifact do CI
              - download: ci
                artifact: drop

              # 2) Extrai o ZIP
              - task: ExtractFiles@1
                displayName: "Extrair artifact PRODUÇÃO"
                inputs:
                  archiveFilePatterns: '$(Pipeline.Workspace)/ci/drop/*.zip'
                  destinationFolder: '$(Pipeline.Workspace)/extracted'
                  cleanDestinationFolder: true

              # 3) Upload para PRODUÇÃO
              # Executa SOMENTE após aprovação manual
              - task: AzureCLI@2
                displayName: "Deploy no Azure Blob PRODUÇÃO"
                inputs:
                  azureSubscription: "sc-weather-app-cicd"
                  scriptType: bash
                  scriptLocation: inlineScript
                  inlineScript: |
                    az storage blob upload-batch \
                      --account-name weatherappproduction \
                      --destination \$web \
                      --source $(Pipeline.Workspace)/extracted \
                      --auth-mode login

